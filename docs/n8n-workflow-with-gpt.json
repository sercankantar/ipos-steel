{
  "name": "IPOS Steel Chatbot (GPT-4o-mini)",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [240, 400],
      "webhookId": "WEBHOOK_ID",
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const userMessage = $input.item.json.message.text || '';\nconst chatId = $input.item.json.message.chat.id;\nconst userName = $input.item.json.message.from.first_name || 'KullanÄ±cÄ±';\n\nconst cleanMessage = userMessage.toLowerCase().trim();\n\n// Komut kontrolÃ¼\nconst commands = {\n  '/start': 'start',\n  'start': 'start',\n  '/help': 'help',\n  'help': 'help',\n  '/contact': 'contact',\n  'contact': 'contact',\n  '/catalog': 'catalog',\n  'catalog': 'catalog'\n};\n\nif (commands[cleanMessage]) {\n  const commandMessages = {\n    start: `ğŸ‘‹ Merhaba ${userName}!\\n\\nğŸ” *IPOS Steel ÃœrÃ¼n Arama Botu*\\n\\nÃœrÃ¼n aramak iÃ§in doÄŸal dilde yazÄ±n:\\nâ€¢ \"50lik kablo kanalÄ± neler var?\"\\nâ€¢ \"pregalvanizli 60lÄ±k istiyorum\"\\nâ€¢ \"sÄ±cak daldÄ±rmalÄ± kanallar\"\\nâ€¢ \"45x60 pregal kanal\"\\n\\nğŸ¤– Yapay zeka destekli arama!\\n\\nğŸ“Œ *Komutlar:*\\n/help - YardÄ±m\\n/contact - Ä°letiÅŸim\\n/catalog - Katalog`,\n    help: `â“ *NasÄ±l KullanÄ±lÄ±r?*\\n\\n*DoÄŸal Dilde Sorun:*\\nâ€¢ \"50lik kablo kanalÄ± var mÄ±?\"\\nâ€¢ \"pregalvanizli 60lÄ±k lazÄ±m\"\\nâ€¢ \"sÄ±cak daldÄ±rmalÄ± kanal\"\\nâ€¢ \"45 60 boyutunda pregal\"\\n\\n*Kaplama Tipleri:*\\nâ€¢ Pregalvaniz (pregal)\\nâ€¢ SÄ±cak DaldÄ±rma\\nâ€¢ Elektro\\nâ€¢ BoyalÄ±\\n\\n*Boyut Ã–rnekleri:*\\nâ€¢ \"50lik\" â†’ 50mm\\nâ€¢ \"45x60\" â†’ 45mm x 60mm\\nâ€¢ \"60 lÄ±k\" â†’ 60mm\\n\\nğŸ¤– Bot sizi anlayacak, endiÅŸelenmeyin!`,\n    contact: `ğŸ“ *Ä°letiÅŸim Bilgileri*\\n\\nâ˜ï¸ Telefon: +90 XXX XXX XX XX\\nâœ‰ï¸ Email: info@ipossteel.com\\nğŸŒ Website: https://ipossteel.com\\nğŸ“ Adres: [Adresiniz]\\n\\nğŸ’¬ Mesai Saatleri:\\nPazartesi - Cuma: 08:30 - 17:30`,\n    catalog: `ğŸ“‹ *Katalog ve DÃ¶kÃ¼manlar*\\n\\nKataloglarÄ±mÄ±zÄ± indirmek iÃ§in:\\nğŸ”— https://ipossteel.com/katalog\\n\\nYardÄ±ma ihtiyacÄ±nÄ±z varsa bize ulaÅŸÄ±n!`\n  };\n  \n  return {\n    json: {\n      isCommand: true,\n      command: commands[cleanMessage],\n      chatId,\n      message: commandMessages[commands[cleanMessage]]\n    }\n  };\n}\n\nif (cleanMessage.length < 2) {\n  return {\n    json: {\n      isCommand: true,\n      command: 'error',\n      chatId,\n      message: `âš ï¸ LÃ¼tfen en az 2 karakter girin.\\n\\nÃ–rnek: \"50lik kanal\" veya \"pregalvaniz\"`\n    }\n  };\n}\n\nconst systemPrompt = `Sen IPOS Steel'in Ã¼rÃ¼n arama asistanÄ±sÄ±n. KullanÄ±cÄ±nÄ±n TÃ¼rkÃ§e sorgusunu analiz edip Ã¼rÃ¼n arama parametrelerine Ã§eviriyorsun.\\n\\n**GÃ¶revin:**\\n1. KullanÄ±cÄ±nÄ±n ne aradÄ±ÄŸÄ±nÄ± anla\\n2. Parametreleri Ã§Ä±kar (boyut, kaplama tipi, Ã¼rÃ¼n tipi)\\n3. Structured format'ta dÃ¶ndÃ¼r\\n\\n**Ã–rnekler:**\\n- \"50lik kablo kanalÄ± neler var\" â†’ searchQuery: \"kablo kanalÄ±\", height: \"50\", width: \"50\"\\n- \"pregalvanizli 60lÄ±k\" â†’ searchQuery: \"kanal\", coatingType: \"pregalvaniz\", height: \"60\", width: \"60\"\\n- \"45x60 pregal kanal\" â†’ searchQuery: \"kablo kanalÄ±\", height: \"45\", width: \"60\", coatingType: \"pregalvaniz\"\\n- \"sÄ±cak daldÄ±rmalÄ± kanallarÄ±nÄ±z var mÄ±?\" â†’ searchQuery: \"kanal\", coatingType: \"sÄ±cak daldÄ±rma\"\\n\\n**Boyut Ã‡evirileri:**\\n- \"50lik\", \"50 lik\", \"50'lik\" â†’ \"50\"\\n- \"45x60\", \"45*60\", \"45 60\" â†’ height: \"45\", width: \"60\"\\n\\n**Kaplama Tipleri:**\\n- \"pregal\", \"pregalvaniz\", \"pregalvanizli\" â†’ \"pregalvaniz\"\\n- \"sÄ±cak daldÄ±rma\", \"sÄ±cak daldÄ±rmalÄ±\", \"galvaniz\" â†’ \"sÄ±cak daldÄ±rma\"\\n- \"elektro\" â†’ \"elektro\"\\n- \"boyalÄ±\", \"boyali\" â†’ \"boyalÄ±\"\\n\\n**ÃœrÃ¼n Tipleri:**\\n- \"kablo kanalÄ±\", \"kanal\" â†’ productType: \"channel\"\\n- \"modÃ¼l\" â†’ productType: \"module\"\\n- \"aksesuar\" â†’ productType: \"accessory\"\\n- \"kapak\" â†’ productType: \"cover\"\\n\\n**Ã–nemli:**\\n- Sadece sayÄ±larÄ± dÃ¶ndÃ¼r (birim yok)\\n- TÃ¼rkÃ§e karakter normalizasyonu yap\\n- EÄŸer boyut tek ise hem height hem width olabilir`;\n\nreturn {\n  json: {\n    isCommand: false,\n    chatId,\n    userName,\n    userMessage: userMessage,\n    cleanMessage: cleanMessage,\n    systemPrompt: systemPrompt\n  }\n};"
      },
      "name": "Mesaj Ã–n Ä°ÅŸleme",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [440, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.isCommand}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Komut mu?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [640, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o-mini',\n  messages: [\n    {\n      role: 'system',\n      content: $json.systemPrompt\n    },\n    {\n      role: 'user',\n      content: $json.userMessage\n    }\n  ],\n  functions: [\n    {\n      name: 'extract_product_search_params',\n      description: 'KullanÄ±cÄ±nÄ±n Ã¼rÃ¼n arama sorgusundan parametreleri Ã§Ä±kar',\n      parameters: {\n        type: 'object',\n        properties: {\n          searchQuery: {\n            type: 'string',\n            description: 'Genel arama terimi (Ã¶rn: kablo kanalÄ±, modÃ¼l, aksesuar)'\n          },\n          coatingType: {\n            type: 'string',\n            enum: ['pregalvaniz', 'sÄ±cak daldÄ±rma', 'elektro', 'boyalÄ±', null],\n            description: 'Kaplama tipi'\n          },\n          height: {\n            type: 'string',\n            description: 'YÃ¼kseklik (mm) - sadece sayÄ±'\n          },\n          width: {\n            type: 'string',\n            description: 'GeniÅŸlik (mm) - sadece sayÄ±'\n          },\n          productType: {\n            type: 'string',\n            enum: ['channel', 'module', 'accessory', 'cover', 'all'],\n            description: 'ÃœrÃ¼n tipi'\n          },\n          intent: {\n            type: 'string',\n            enum: ['search', 'info', 'price', 'availability', 'general'],\n            description: 'KullanÄ±cÄ±nÄ±n niyeti'\n          }\n        },\n        required: ['searchQuery', 'intent']\n      }\n    }\n  ],\n  function_call: { name: 'extract_product_search_params' },\n  temperature: 0.3\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "name": "GPT Mesaj Analizi",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [840, 500],
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPENAI_CREDENTIAL_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const chatId = $('Mesaj Ã–n Ä°ÅŸleme').item.json.chatId;\nconst originalMessage = $('Mesaj Ã–n Ä°ÅŸleme').item.json.userMessage;\nconst gptResponse = $input.item.json;\n\ntry {\n  const functionCall = gptResponse.choices[0].message.function_call;\n  const params = JSON.parse(functionCall.arguments);\n  \n  console.log('GPT Extracted Params:', params);\n  \n  const apiParams = {\n    q: params.searchQuery || '',\n    coatingType: params.coatingType || undefined,\n    height: params.height || undefined,\n    width: params.width || undefined\n  };\n  \n  Object.keys(apiParams).forEach(key => {\n    if (apiParams[key] === undefined || apiParams[key] === null || apiParams[key] === '') {\n      delete apiParams[key];\n    }\n  });\n  \n  if (Object.keys(apiParams).length === 0) {\n    return {\n      json: {\n        isError: true,\n        chatId,\n        message: `âš ï¸ ÃœzgÃ¼nÃ¼m, aramanÄ±zÄ± anlayamadÄ±m.\\n\\nLÃ¼tfen daha aÃ§Ä±k bir ÅŸekilde belirtin:\\nâ€¢ ÃœrÃ¼n adÄ±: \"kablo kanalÄ±\"\\nâ€¢ Boyut: \"50lik\" veya \"45x60\"\\nâ€¢ Kaplama: \"pregalvaniz\", \"sÄ±cak daldÄ±rma\"\\n\\nÃ–rnek: \"50lik pregalvaniz kablo kanalÄ±\"`\n      }\n    };\n  }\n  \n  return {\n    json: {\n      isError: false,\n      chatId,\n      originalMessage,\n      apiParams,\n      gptParams: params,\n      intent: params.intent\n    }\n  };\n  \n} catch (error) {\n  console.error('GPT Parse Error:', error);\n  \n  return {\n    json: {\n      isError: true,\n      chatId,\n      message: `âŒ Arama sÄ±rasÄ±nda bir hata oluÅŸtu.\\n\\nLÃ¼tfen tekrar deneyin veya daha basit bir ÅŸekilde sorun.\\n\\nÃ–rnek: \"50lik kablo kanalÄ±\"`\n    }\n  };\n}"
      },
      "name": "GPT Ã‡Ä±ktÄ±sÄ±nÄ± Parse Et",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1040, 500]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.isError}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Hata Var mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1240, 500]
    },
    {
      "parameters": {
        "url": "=https://YOUR-DOMAIN.com/api/search/products",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{$json.apiParams.q}}"
            },
            {
              "name": "coatingType",
              "value": "={{$json.apiParams.coatingType}}"
            },
            {
              "name": "height",
              "value": "={{$json.apiParams.height}}"
            },
            {
              "name": "width",
              "value": "={{$json.apiParams.width}}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "name": "API ÃœrÃ¼n Arama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1440, 600]
    },
    {
      "parameters": {
        "functionCode": "const chatId = $('GPT Ã‡Ä±ktÄ±sÄ±nÄ± Parse Et').item.json.chatId;\nconst originalMessage = $('GPT Ã‡Ä±ktÄ±sÄ±nÄ± Parse Et').item.json.originalMessage;\nconst apiResponse = $input.item.json;\n\nif (!apiResponse.success) {\n  return {\n    json: {\n      chatId,\n      message: `âŒ Arama sÄ±rasÄ±nda bir hata oluÅŸtu.\\n\\nLÃ¼tfen tekrar deneyin veya bize ulaÅŸÄ±n:\\nâ˜ï¸ +90 XXX XXX XX XX`,\n      replyMarkup: {\n        inline_keyboard: [\n          [\n            { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' },\n            { text: 'â˜ï¸ Ä°letiÅŸim', callback_data: 'contact' }\n          ]\n        ]\n      }\n    }\n  };\n}\n\nconst results = apiResponse.results || [];\nconst totalResults = apiResponse.totalResults || 0;\nconst query = apiResponse.query;\n\nif (totalResults === 0) {\n  return {\n    json: {\n      chatId,\n      message: `ğŸ” *Arama: \"${originalMessage}\"*\\n\\nâŒ ÃœzgÃ¼nÃ¼m, aradÄ±ÄŸÄ±nÄ±z kriterlerde Ã¼rÃ¼n bulamadÄ±m.\\n\\nğŸ’¡ *Ã–neriler:*\\nâ€¢ FarklÄ± boyutlar deneyin\\nâ€¢ Sadece \"kablo kanalÄ±\" yazÄ±n\\nâ€¢ Kaplama tipini deÄŸiÅŸtirin\\n\\nğŸ“ Ã–zel talepleriniz iÃ§in:\\nâ˜ï¸ +90 XXX XXX XX XX\\nâœ‰ï¸ info@ipossteel.com`,\n      replyMarkup: {\n        inline_keyboard: [\n          [\n            { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' }\n          ],\n          [\n            { text: 'â˜ï¸ Ä°letiÅŸim', callback_data: 'contact' },\n            { text: 'ğŸ“‹ Katalog', url: 'https://ipossteel.com/katalog' }\n          ]\n        ]\n      }\n    }\n  };\n}\n\nlet message = `ğŸ” *Sorgunuz: \"${originalMessage}\"*\\n\\n`;\nmessage += `âœ… *${totalResults} Ã¼rÃ¼n bulundu!*\\n\\n`;\nmessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\nresults.slice(0, 5).forEach((product, index) => {\n  message += `*${index + 1}. ${product.name}*\\n`;\n  \n  if (product.code) {\n    message += `ğŸ·ï¸ Kod: \\`${product.code}\\`\\n`;\n  }\n  \n  if (product.typeName) {\n    message += `ğŸ“¦ Tip: ${product.typeName}\\n`;\n  }\n  \n  if (product.height && product.width) {\n    message += `ğŸ“ Boyut: ${product.height}Ã—${product.width} mm\\n`;\n  }\n  \n  if (product.coatingType) {\n    message += `ğŸ¨ Kaplama: ${product.coatingType}\\n`;\n  }\n  \n  if (product.sheetThickness) {\n    message += `ğŸ“ Sac: ${product.sheetThickness} mm\\n`;\n  }\n  \n  if (product.categoryName) {\n    message += `ğŸ“‚ ${product.categoryName}\\n`;\n  }\n  \n  message += `\\n`;\n});\n\nif (totalResults > 5) {\n  message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\n  message += `_...ve ${totalResults - 5} Ã¼rÃ¼n daha_\\n\\n`;\n}\n\nmessage += `\\nğŸ“ *DetaylÄ± Bilgi ve Teklif:*\\n`;\nmessage += `â˜ï¸ +90 XXX XXX XX XX\\n`;\nmessage += `âœ‰ï¸ info@ipossteel.com\\n`;\nmessage += `ğŸŒ ipossteel.com`;\n\nreturn {\n  json: {\n    chatId,\n    message,\n    results: results.slice(0, 5),\n    replyMarkup: {\n      inline_keyboard: [\n        [\n          { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' },\n          { text: 'â˜ï¸ Teklif Ä°ste', callback_data: 'request_quote' }\n        ],\n        [\n          { text: 'ğŸ“– Katalog', url: 'https://ipossteel.com/katalog' }\n        ]\n      ]\n    }\n  }\n};"
      },
      "name": "YanÄ±t Formatlama",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1640, 600]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true,
          "reply_markup": "={{JSON.stringify($json.replyMarkup)}}"
        }
      },
      "name": "Telegram Cevap (SonuÃ§)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1840, 600],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "name": "Telegram Cevap (Komut)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [840, 300],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "name": "Telegram Cevap (Hata)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1440, 400],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Mesaj Ã–n Ä°ÅŸleme",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mesaj Ã–n Ä°ÅŸleme": {
      "main": [
        [
          {
            "node": "Komut mu?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Komut mu?": {
      "main": [
        [
          {
            "node": "Telegram Cevap (Komut)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GPT Mesaj Analizi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT Mesaj Analizi": {
      "main": [
        [
          {
            "node": "GPT Ã‡Ä±ktÄ±sÄ±nÄ± Parse Et",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT Ã‡Ä±ktÄ±sÄ±nÄ± Parse Et": {
      "main": [
        [
          {
            "node": "Hata Var mÄ±?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hata Var mÄ±?": {
      "main": [
        [
          {
            "node": "Telegram Cevap (Hata)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API ÃœrÃ¼n Arama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API ÃœrÃ¼n Arama": {
      "main": [
        [
          {
            "node": "YanÄ±t Formatlama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "YanÄ±t Formatlama": {
      "main": [
        [
          {
            "node": "Telegram Cevap (SonuÃ§)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "1",
      "name": "chatbot"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "2",
      "name": "gpt-powered"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "2"
}

