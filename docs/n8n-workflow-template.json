{
  "name": "IPOS Steel Chatbot",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ]
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "BURAYA_WEBHOOK_ID_GELECEK",
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// KullanÄ±cÄ± mesajÄ±nÄ± al\nconst userMessage = $input.item.json.message.text || '';\nconst chatId = $input.item.json.message.chat.id;\nconst userName = $input.item.json.message.from.first_name || 'KullanÄ±cÄ±';\n\n// MesajÄ± temizle\nconst cleanMessage = userMessage.toLowerCase().trim();\n\n// Ã–zel komutlarÄ± kontrol et\nif (cleanMessage === '/start' || cleanMessage === 'start') {\n  return {\n    json: {\n      isCommand: true,\n      command: 'start',\n      chatId,\n      userName,\n      message: `ğŸ‘‹ Merhaba ${userName}!\\n\\nğŸ” *IPOS Steel ÃœrÃ¼n Arama Botu*\\n\\nÃœrÃ¼n aramak iÃ§in:\\nâ€¢ ÃœrÃ¼n adÄ± yazÄ±n: \"kablo kanalÄ±\"\\nâ€¢ Boyut ekleyin: \"45x60 kanal\"\\nâ€¢ Kaplama belirtin: \"pregalvaniz kanal\"\\nâ€¢ Hepsini birleÅŸtirin: \"pregalvaniz kablo kanalÄ± 45x60\"\\n\\nğŸ“Œ *Komutlar:*\\n/help - YardÄ±m\\n/contact - Ä°letiÅŸim\\n/catalog - Katalog indir`\n    }\n  };\n}\n\nif (cleanMessage === '/help' || cleanMessage === 'help') {\n  return {\n    json: {\n      isCommand: true,\n      command: 'help',\n      chatId,\n      message: `â“ *NasÄ±l KullanÄ±lÄ±r?*\\n\\n*Ã–rnek Aramalar:*\\nâ€¢ \"kablo kanalÄ±\" â†’ TÃ¼m kablo kanallarÄ±\\nâ€¢ \"45x60\" â†’ Bu boyuttaki Ã¼rÃ¼nler\\nâ€¢ \"pregalvaniz kanal\" â†’ Pregalvaniz kaplÄ± kanallar\\nâ€¢ \"pregalvaniz 45x60\" â†’ Tam arama\\n\\n*Kaplama Tipleri:*\\nâ€¢ Pregalvaniz\\nâ€¢ SÄ±cak DaldÄ±rma\\nâ€¢ Elektro\\nâ€¢ BoyalÄ±\\n\\n*Ä°pucu:* BoyutlarÄ± \"45x60\" veya \"45*60\" ÅŸeklinde yazabilirsiniz.`\n    }\n  };\n}\n\nif (cleanMessage === '/contact' || cleanMessage === 'contact') {\n  return {\n    json: {\n      isCommand: true,\n      command: 'contact',\n      chatId,\n      message: `ğŸ“ *Ä°letiÅŸim Bilgileri*\\n\\nâ˜ï¸ Telefon: +90 XXX XXX XX XX\\nâœ‰ï¸ Email: info@ipossteel.com\\nğŸŒ Website: https://ipossteel.com\\nğŸ“ Adres: [Adresiniz]\\n\\nğŸ’¬ Mesai Saatleri:\\nPazartesi - Cuma: 08:30 - 17:30`\n    }\n  };\n}\n\nif (cleanMessage === '/catalog' || cleanMessage === 'catalog') {\n  return {\n    json: {\n      isCommand: true,\n      command: 'catalog',\n      chatId,\n      message: `ğŸ“‹ *Katalog ve DÃ¶kÃ¼manlar*\\n\\nKataloglarÄ±mÄ±zÄ± indirmek iÃ§in:\\nğŸ”— https://ipossteel.com/katalog\\n\\nYardÄ±ma ihtiyacÄ±nÄ±z varsa bize ulaÅŸÄ±n!`\n    }\n  };\n}\n\n// EÄŸer komut deÄŸilse, arama yap\nif (!cleanMessage || cleanMessage.length < 2) {\n  return {\n    json: {\n      isCommand: true,\n      command: 'error',\n      chatId,\n      message: `âš ï¸ LÃ¼tfen en az 2 karakter girin.\\n\\nÃ–rnek: \"kablo kanalÄ±\" veya \"45x60\"`\n    }\n  };\n}\n\n// Boyut tespiti\nconst dimensionMatch = cleanMessage.match(/(\\d+)\\s*[x*Ã—\\s-]+\\s*(\\d+)/);\nconst height = dimensionMatch ? dimensionMatch[1] : null;\nconst width = dimensionMatch ? dimensionMatch[2] : null;\n\n// Kaplama tipi tespiti\nconst coatingTypes = {\n  'pregalvaniz': 'pregalvaniz',\n  'pregal': 'pregalvaniz',\n  'sÄ±cak daldÄ±rma': 'sÄ±cak daldÄ±rma',\n  'sicak daldirma': 'sÄ±cak daldÄ±rma',\n  'daldÄ±rma': 'sÄ±cak daldÄ±rma',\n  'elektro': 'elektro',\n  'boyalÄ±': 'boyalÄ±',\n  'boyali': 'boyalÄ±'\n};\n\nlet coatingType = null;\nfor (const [key, value] of Object.entries(coatingTypes)) {\n  if (cleanMessage.includes(key)) {\n    coatingType = value;\n    break;\n  }\n}\n\n// Kategori tespiti\nlet category = null;\nif (cleanMessage.includes('kablo') || cleanMessage.includes('kanal')) {\n  category = 'kablo-kanallari';\n}\n\n// API parametrelerini oluÅŸtur\nconst apiParams = {\n  q: cleanMessage,\n  coatingType: coatingType || undefined,\n  height: height || undefined,\n  width: width || undefined,\n  category: category || undefined\n};\n\n// Undefined deÄŸerleri temizle\nObject.keys(apiParams).forEach(key => {\n  if (apiParams[key] === undefined) {\n    delete apiParams[key];\n  }\n});\n\nreturn {\n  json: {\n    isCommand: false,\n    chatId,\n    userName,\n    originalMessage: userMessage,\n    cleanMessage,\n    apiParams,\n    parsedData: {\n      height,\n      width,\n      coatingType,\n      category\n    }\n  }\n};"
      },
      "name": "Mesaj Analizi",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        440,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.isCommand}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Komut mu Arama mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        640,
        300
      ]
    },
    {
      "parameters": {
        "url": "=https://YOUR-DOMAIN.com/api/search/products",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{$json.apiParams.q}}"
            },
            {
              "name": "coatingType",
              "value": "={{$json.apiParams.coatingType}}"
            },
            {
              "name": "height",
              "value": "={{$json.apiParams.height}}"
            },
            {
              "name": "width",
              "value": "={{$json.apiParams.width}}"
            },
            {
              "name": "category",
              "value": "={{$json.apiParams.category}}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "name": "API ÃœrÃ¼n Arama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        840,
        400
      ]
    },
    {
      "parameters": {
        "functionCode": "const chatId = $('Mesaj Analizi').item.json.chatId;\nconst userName = $('Mesaj Analizi').item.json.userName;\nconst originalMessage = $('Mesaj Analizi').item.json.originalMessage;\nconst apiResponse = $input.item.json;\n\n// API hatasÄ± kontrolÃ¼\nif (!apiResponse.success) {\n  return {\n    json: {\n      chatId,\n      message: `âŒ Arama sÄ±rasÄ±nda bir hata oluÅŸtu.\\n\\nLÃ¼tfen tekrar deneyin veya bize ulaÅŸÄ±n:\\nâ˜ï¸ +90 XXX XXX XX XX`,\n      replyMarkup: {\n        inline_keyboard: [\n          [\n            { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' },\n            { text: 'â˜ï¸ Ä°letiÅŸim', callback_data: 'contact' }\n          ]\n        ]\n      }\n    }\n  };\n}\n\nconst results = apiResponse.results || [];\nconst totalResults = apiResponse.totalResults || 0;\nconst query = apiResponse.query;\n\n// SonuÃ§ yoksa\nif (totalResults === 0) {\n  return {\n    json: {\n      chatId,\n      message: `ğŸ” *Arama: \"${query}\"*\\n\\nâŒ ÃœzgÃ¼nÃ¼m, aradÄ±ÄŸÄ±nÄ±z kriterlerde Ã¼rÃ¼n bulamadÄ±m.\\n\\nğŸ’¡ *Ã–neriler:*\\nâ€¢ FarklÄ± boyutlar deneyin\\nâ€¢ Sadece Ã¼rÃ¼n adÄ±nÄ± yazÄ±n (Ã¶rn: \"kablo kanalÄ±\")\\nâ€¢ Kaplama tipini deÄŸiÅŸtirin\\n\\nğŸ“ Ã–zel talepleriniz iÃ§in:\\nâ˜ï¸ +90 XXX XXX XX XX\\nâœ‰ï¸ info@ipossteel.com`,\n      replyMarkup: {\n        inline_keyboard: [\n          [\n            { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' }\n          ],\n          [\n            { text: 'â˜ï¸ Ä°letiÅŸim', callback_data: 'contact' },\n            { text: 'ğŸ“‹ Katalog', url: 'https://ipossteel.com/katalog' }\n          ]\n        ]\n      }\n    }\n  };\n}\n\n// SonuÃ§ varsa\nlet message = `ğŸ” *Arama: \"${query}\"*\\n\\n`;\nmessage += `âœ… *${totalResults} Ã¼rÃ¼n bulundu!*\\n\\n`;\nmessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// Ä°lk 5 sonucu gÃ¶ster\nresults.slice(0, 5).forEach((product, index) => {\n  message += `*${index + 1}. ${product.name}*\\n`;\n  \n  if (product.code) {\n    message += `ğŸ·ï¸ Kod: \\`${product.code}\\`\\n`;\n  }\n  \n  if (product.typeName) {\n    message += `ğŸ“¦ Tip: ${product.typeName}\\n`;\n  }\n  \n  if (product.height && product.width) {\n    message += `ğŸ“ Boyut: ${product.height}Ã—${product.width} mm\\n`;\n  }\n  \n  if (product.coatingType) {\n    message += `ğŸ¨ Kaplama: ${product.coatingType}\\n`;\n  }\n  \n  if (product.sheetThickness) {\n    message += `ğŸ“ Sac: ${product.sheetThickness} mm\\n`;\n  }\n  \n  if (product.categoryName) {\n    message += `ğŸ“‚ ${product.categoryName}\\n`;\n  }\n  \n  message += `\\n`;\n});\n\nif (totalResults > 5) {\n  message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\n  message += `_...ve ${totalResults - 5} Ã¼rÃ¼n daha_\\n\\n`;\n}\n\nmessage += `\\nğŸ“ *DetaylÄ± Bilgi ve Teklif:*\\n`;\nmessage += `â˜ï¸ +90 XXX XXX XX XX\\n`;\nmessage += `âœ‰ï¸ info@ipossteel.com\\n`;\nmessage += `ğŸŒ ipossteel.com`;\n\nreturn {\n  json: {\n    chatId,\n    message,\n    results: results.slice(0, 5),\n    replyMarkup: {\n      inline_keyboard: [\n        [\n          { text: 'ğŸ” Yeni Arama', callback_data: 'new_search' },\n          { text: 'â˜ï¸ Teklif Ä°ste', callback_data: 'request_quote' }\n        ],\n        [\n          { text: 'ğŸ“– Katalog', url: 'https://ipossteel.com/katalog' }\n        ]\n      ]\n    }\n  }\n};"
      },
      "name": "YanÄ±t Formatlama",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1040,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true,
          "reply_markup": "={{JSON.stringify($json.replyMarkup)}}"
        }
      },
      "name": "Telegram Cevap (Arama)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1240,
        400
      ],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "name": "Telegram Cevap (Komut)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        840,
        200
      ],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram account"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Mesaj Analizi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mesaj Analizi": {
      "main": [
        [
          {
            "node": "Komut mu Arama mÄ±?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Komut mu Arama mÄ±?": {
      "main": [
        [
          {
            "node": "Telegram Cevap (Komut)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API ÃœrÃ¼n Arama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API ÃœrÃ¼n Arama": {
      "main": [
        [
          {
            "node": "YanÄ±t Formatlama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "YanÄ±t Formatlama": {
      "main": [
        [
          {
            "node": "Telegram Cevap (Arama)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "1",
      "name": "chatbot"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "2",
      "name": "ipos-steel"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}

